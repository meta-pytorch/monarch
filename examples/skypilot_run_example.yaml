# SkyPilot YAML for running Monarch SkyPilot example from outside the cluster
#
# This YAML launches a "client" pod that runs the skypilot_getting_started.py
# script. The script then uses SkyPilotJob to launch additional "worker" pods.
#
# Usage:
#   sky launch examples/skypilot_run_example.yaml
#
# Requirements:
#   - SkyPilot configured with Kubernetes access (sky check)
#   - Kubernetes cluster with GPU nodes available
#
# Note: Cold start is slow (~7-10 minutes) because both the client and workers
# need to build Monarch from source to ensure version compatibility.

name: monarch-skypilot-example

resources:
  cloud: kubernetes
  # Client pod needs minimal resources - workers do the heavy lifting
  cpus: 4+
  memory: 16+
  # Request a GPU for the client too (needed to build Monarch with CUDA support)
  accelerators: H200:1

# Sync the Monarch repository to the client pod
workdir: .

setup: |
  set -ex
  
  echo "=== Setting up Monarch client pod ==="
  
  # Add PPA for newer toolchains
  sudo apt-get update
  sudo apt-get install -y software-properties-common
  sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
  sudo apt-get update
  
  # Install system dependencies
  sudo apt-get install -y \
    build-essential \
    ninja-build \
    g++-11 \
    rdma-core \
    libibverbs1 \
    libmlx5-1 \
    libibverbs-dev \
    curl \
    pkg-config \
    libssl-dev
  
  # Install CUDA toolkit and NCCL
  wget -q https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.1-1_all.deb
  sudo dpkg -i cuda-keyring_1.1-1_all.deb
  sudo apt-get update
  sudo apt-get install -y cuda-toolkit-12-1
  sudo apt-get install -y --allow-change-held-packages libnccl2=2.28.9-1+cuda12.9 libnccl-dev=2.28.9-1+cuda12.9
  
  # Install Rust
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  source $HOME/.cargo/env
  rustup default nightly
  
  # Install SkyPilot with Kubernetes support
  pip install "skypilot[kubernetes]"
  
  # Install Python dependencies and build Monarch from source
  cd ~/sky_workdir
  pip install setuptools-rust maturin
  pip install -r torch-requirements.txt -r build-requirements.txt
  CC=gcc-11 CXX=g++-11 USE_TENSOR_ENGINE=0 pip install --no-build-isolation -e .
  
  echo "=== Client setup complete ==="

run: |
  set -ex
  source $HOME/.cargo/env
  cd ~/sky_workdir
  
  # Set timeouts for worker communication
  export HYPERACTOR_HOST_SPAWN_READY_TIMEOUT=15m
  export HYPERACTOR_MESSAGE_DELIVERY_TIMEOUT=15m
  export HYPERACTOR_MESH_PROC_SPAWN_MAX_IDLE=15m
  
  # Run the example
  # Using --num-hosts 1 and --gpus-per-host 1 for a minimal test
  # Adjust these values based on available cluster resources
  python examples/skypilot_getting_started.py \
    --cloud kubernetes \
    --num-hosts 1 \
    --gpus-per-host 1 \
    --accelerator "H200:1" \
    --cluster-name monarch-workers


